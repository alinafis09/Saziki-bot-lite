import axios from 'axios';

import * as cheerio from 'cheerio';

let handler = async (m, { args, conn, text, usedPrefix, command }) => {

  if (!text) throw `> âš ï¸ *ð™ð™–ð™˜ð™šð™—ð™¤ð™¤ð™  ð™¡ð™žð™£ð™ *`;

  const platform = 'facebook';

  try {

    const links = await fetchDownloadLinks(text, platform, conn, m);

    if (!links) return;

    if (links.length === 0)

      return await conn.sendMessage(m.chat, { text: 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±ÙˆØ§Ø¨Ø· ØªØ­Ù…ÙŠÙ„.' }, { quoted: m });

    let download = getDownloadLink(platform, links);

    if (!download)

      return await conn.sendMessage(m.chat, { text: 'âŒ ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„.' }, { quoted: m });

    if (Array.isArray(download)) {

      for (const media of download) {

        try {

          await conn.sendMessage(m.chat, {

            image: { url: media },

            caption: `ðŸ“¥ Instagram Downloader\n${media}`

          }, { quoted: m });

        } catch (err) {

          console.log(`Error sending ${media}:`, err.message);

        }

      }

    } else {

      try {

        const ext = download.includes('.mp4') ? 'mp4' : 'jpg';

        const caption = `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­`;

        if (ext === 'mp4') {

          await conn.sendMessage(m.chat, { video: { url: download }, caption }, { quoted: m });

        } else {

          await conn.sendMessage(m.chat, { image: { url: download }, caption }, { quoted: m });

        }

      } catch (err) {

        return await conn.sendMessage(m.chat, {

          text: `âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù:\n${err.message}`

        }, { quoted: m });

      }

    }

  } catch (error) {

    console.log('Downloader Error:', error);

    return await conn.sendMessage(m.chat, {

      text: `âŒ Ø­Ø¯Ø« Ø®Ø·Ø£:\n${error.message || error}`

    }, { quoted: m });

  }

};

handler.command = /^(facebook|fb|fbdl)$/i;

handler.tags = ['downloader'];

handler.help = ['facebook'];

export default handler;

async function fetchDownloadLinks(text, platform, conn, m) {

  const { SITE_URL, form } = createApiRequest(text, platform);

  const res = await axios.post(`${SITE_URL}api`, form.toString(), {

    headers: {

      'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',

      'Origin': SITE_URL,

      'Referer': SITE_URL,

      'User-Agent': 'Mozilla/5.0',

      'X-Requested-With': 'XMLHttpRequest'

    }

  });

  const html = res?.data?.html;

  if (!html || res?.data?.status !== 'success') {

    await conn.sendMessage(m.chat, { text: 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.' }, { quoted: m });

    return null;

  }

  const $ = cheerio.load(html);

  const links = [];

  $('a.btn[href^="http"]').each((_, el) => {

    const link = $(el).attr('href');

    if (link && !links.includes(link)) links.push(link);

  });  return links;

}

function createApiRequest(text, platform) {

  const SITE_URL = 'https://ssstik.io/';

  const form = new URLSearchParams();

  form.append('url', text);

  form.append('platform', platform);

  form.append('siteurl', SITE_URL);

  return { SITE_URL, form };

}

function getDownloadLink(platform, links) {

  if (platform === 'instagram') return links;

  if (platform === 'tiktok') return links.find(link => /hdplay/.test(link)) || links[0];

  if (platform === 'facebook') return links.at(-1);

  return null;

}